# SIP客户端 (模块化版本)

## 打包说明

SIP客户端已成功打包为独立可执行文件(.exe)。您可以通过以下步骤使用打包好的应用程序：

1. 在`dist`目录中找到`SIPClient.exe`文件
2. 直接双击运行此文件，无需安装Python或其他依赖
3. 如果您需要自己打包应用程序，请参考`README_PACKAGING.md`文件

如果您想了解打包过程和结果，请查看`打包总结.md`文件。

## 项目介绍

这是一个基于PJSUA的SIP客户端，提供图形界面进行SIP电话操作。该项目采用模块化结构设计，将UI和业务逻辑分离，提高代码可维护性和可读性。

## 功能特性

- 连接到SIP服务器进行认证和通信
- 拨打和接听SIP电话
- 可视化的通话状态和时间显示
- 直观的数字键盘拨号界面
- 自动端口选择和管理
- 详细的日志记录和查看功能
- 用户配置的自动保存和加载
- 启动时自动登录选项
- 全局异常处理和错误日志记录
- 模块化架构设计，便于维护和扩展

## 项目结构

```
.
├── main.py               # 主程序入口
├── sip_client.py         # SIP客户端主类
├── sip_client_tk_real.py # 原始未重构的客户端代码（参考用）
├── pjsua.exe             # PJSUA可执行文件
├── sip_client_config.json# 用户配置文件
├── gui/                  # GUI相关代码
│   ├── __init__.py
│   ├── ui_manager.py     # UI管理器（主界面管理）
│   ├── dial_panel.py     # 拨号面板（拨号和通话控制）
│   ├── status_panel.py   # 状态显示面板（显示通话状态和计时）
│   └── settings_panel.py # 设置面板（配置服务器和程序参数）
├── core/                 # 核心功能代码
│   ├── __init__.py
│   ├── sip_manager.py    # SIP通信管理（处理SIP通信逻辑）
│   └── pjsua_utils.py    # PJSUA工具函数（与PJSUA交互）
└── utils/                # 工具函数
    ├── __init__.py
    ├── logger.py         # 日志管理（日志记录和管理）
    └── config_manager.py # 配置管理（读写配置文件）
```

## 技术架构

本项目采用以下技术架构：

- **前端**：使用Python的Tkinter库构建图形用户界面
- **通信**：通过管道与PJSUA.exe交互，处理SIP协议通信
- **配置管理**：使用JSON格式保存和读取用户配置
- **日志系统**：采用Python的logging模块记录程序运行日志

### 模块间的交互

- **SIPClient**：作为应用程序的主控制器，协调各模块工作
- **UIManager**：管理所有UI组件，处理用户交互
- **SIPManager**：管理与PJSUA的通信，处理SIP协议相关操作
- **ConfigManager**：负责配置的保存和加载
- **Logger**：提供全局日志记录功能

## 安装要求

- Python 3.6+
- Python tkinter库（GUI界面）
- PJSUA可执行文件（已包含在项目中）
- Windows操作系统（由于使用了Windows特定的进程调用方式）

## 安装指南

1. 克隆或下载本项目到本地
2. 确保安装了Python 3.6或更高版本
3. 确保已安装tkinter库（大多数Python安装中默认包含）
4. 可选：创建并激活虚拟环境：
   ```
   python -m venv venv
   venv\Scripts\activate
   ```

## 使用方法

1. 运行主程序：
   ```
   python main.py
   ```

2. 配置SIP服务器：
   - 服务器地址：输入SIP服务器的域名或IP地址
   - 用户名：SIP账户用户名
   - 密码：SIP账户密码
   - 端口：本地使用的端口（可使用"自动查找端口"功能）

3. 连接到服务器：
   - 点击"登录"按钮连接到SIP服务器
   - 连接状态将在状态面板中显示

4. 拨打电话：
   - 在拨号区域输入目标号码（可使用数字键盘或直接输入）
   - 点击"拨打"按钮发起呼叫
   - 通话状态和时长将在状态面板中实时显示

5. 结束通话：
   - 点击"挂断"按钮结束当前通话

### 配置保存

- 应用程序会自动保存您的服务器信息、端口和PJSUA路径设置到`sip_client_config.json`文件
- 您可以在设置面板中勾选"启动时自动登录"选项，这样下次启动时会自动连接到服务器
- 设置更改后，点击"保存设置"按钮立即保存更改

## 常见问题及解决方案

- **无法连接到服务器**: 
  - 检查服务器地址、用户名和密码是否正确
  - 确认网络连接是否正常
  - 检查防火墙是否阻止了SIP通信端口

- **端口被占用**: 
  - 点击"自动查找端口"尝试使用其他可用端口
  - 也可手动指定一个未被占用的端口

- **通话无法建立**: 
  - 检查目标号码是否正确
  - 确认目标用户是否在线
  - 检查网络连接是否稳定

- **PJSUA不能正常启动**: 
  - 检查PJSUA.exe文件是否存在于程序目录
  - 确认程序有足够权限运行PJSUA.exe
  - 检查日志查看PJSUA启动错误信息

- **配置文件问题**: 
  - 如果配置文件损坏，删除 `sip_client_config.json` 文件后重启应用程序

## 开发指南

### 模块分工

- **gui/**: 包含所有与用户界面相关的代码
  - `ui_manager.py`: 主界面管理和组织
  - `dial_panel.py`: 拨号和通话控制界面
  - `status_panel.py`: 状态显示和计时器
  - `settings_panel.py`: 设置和配置界面

- **core/**: 包含SIP通信和PJSUA交互的核心功能
  - `sip_manager.py`: SIP通信管理和状态处理
  - `pjsua_utils.py`: 与PJSUA程序的交互工具

- **utils/**: 包含通用工具函数和类
  - `logger.py`: 日志管理和记录
  - `config_manager.py`: 配置文件的读写和管理

### 拓展指南

1. **添加新功能**:
   - UI相关功能应在gui/目录中实现
   - 通信相关功能应在core/目录中实现
   - 通用工具应在utils/目录中实现

2. **修改现有功能**:
   - 遵循模块化设计原则，保持接口稳定
   - 修改前理解各模块之间的交互关系

3. **调试方法**:
   - 查看日志文件了解程序运行情况
   - 使用内置的日志功能记录调试信息

### 异常处理

应用程序包含全局异常处理机制，所有未捕获的异常会被记录到日志中，并显示用户友好的错误消息。

### 增加新配置项

如果需要添加新的配置项：
1. 在 `ConfigManager` 类的 `load_config` 方法的默认配置字典中添加新项
2. 在相应的UI组件中添加设置项
3. 在 `save_settings_to_config` 方法中确保新配置项被保存 

## 注意事项

- 本程序依赖PJSUA.exe进行SIP通信，请勿删除或移动此文件
- 程序在Windows环境下开发和测试，在其他操作系统上可能需要修改
- 使用前请确认您拥有合法的SIP账户 